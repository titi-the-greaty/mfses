<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SeeSaw MFSES Dashboard</title>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lightweight-charts@4.2.2/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg: #0a0c10;
            --surface: #12151c;
            --surface2: #1a1e28;
            --border: #232938;
            --text: #e2e8f0;
            --text-dim: #8892a8;
            --text-faint: #4a5568;
            --accent: #22d3ee;
            --accent2: #a78bfa;
            --green: #34d399;
            --orange: #fb923c;
            --red: #f87171;
            --yellow: #fbbf24;
            --blue: #60a5fa;
            --pink: #f472b6;
            --mono: 'JetBrains Mono', monospace;
            --font: 'Outfit', sans-serif;
            --radius: 10px
        }

        [data-theme=light] {
            --bg: #f5f6fa;
            --surface: #fff;
            --surface2: #f0f1f5;
            --border: #e2e5ee;
            --text: #1a1e2e;
            --text-dim: #5a6178;
            --text-faint: #9ca3b8;
            --accent: #0891b2;
            --accent2: #7c3aed;
            --green: #059669;
            --orange: #ea580c;
            --red: #dc2626;
            --yellow: #d97706;
            --blue: #2563eb;
            --pink: #db2777
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: var(--font);
            line-height: 1.5
        }

        input,
        select,
        button {
            font-family: var(--font)
        }

        .header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 14px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1)
        }

        .logo {
            font-size: 22px;
            font-weight: 800;
            letter-spacing: -1px;
            display: flex;
            align-items: baseline;
            gap: 0
        }

        .logo span {
            display: inline
        }

        .logo span:first-child {
            color: var(--accent)
        }

        .logo span:nth-child(2) {
            color: var(--accent2)
        }

        .header-r {
            display: flex;
            align-items: center;
            gap: 12px
        }

        .hbadge {
            font-family: var(--mono);
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 20px;
            background: rgba(52, 211, 153, .12);
            color: var(--green)
        }

        .tbtn {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 12px;
            cursor: pointer;
            color: var(--text-dim);
            font-size: 14px
        }

        .tbtn:hover {
            border-color: var(--accent);
            color: var(--accent)
        }

        .toolbar {
            padding: 14px 24px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            border-bottom: 1px solid var(--border);
            background: var(--surface);
            position: sticky;
            top: 52px;
            z-index: 99
        }

        .sbox {
            flex: 1;
            min-width: 180px;
            padding: 8px 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
            font-size: 14px;
            outline: none
        }

        .sbox:focus {
            border-color: var(--accent)
        }

        .sbox::placeholder {
            color: var(--text-faint)
        }

        .fsel {
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
            font-size: 12px;
            cursor: pointer;
            outline: none
        }

        .fsel:focus {
            border-color: var(--accent)
        }

        .tg {
            display: flex;
            align-items: center;
            gap: 5px
        }

        .tl {
            font-size: 10px;
            color: var(--text-faint);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: var(--mono)
        }

        .sbar {
            padding: 8px 24px;
            display: flex;
            gap: 18px;
            flex-wrap: wrap;
            font-family: var(--mono);
            font-size: 11px;
            color: var(--text-dim);
            border-bottom: 1px solid var(--border);
            background: var(--surface);
            position: sticky;
            top: 112px;
            z-index: 98
        }

        .st {
            display: flex;
            align-items: center;
            gap: 4px
        }

        .sv {
            font-weight: 700;
            color: var(--text)
        }

        .tw {
            height: calc(100vh - 184px);
            overflow-y: auto;
            overflow-x: auto;
            padding: 0 16px 20px;
            margin: 0
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            position: relative;
            margin: 0
        }

        thead {
            position: sticky;
            top: 0;
            z-index: 50;
            background: var(--surface2);
            margin: 0;
            padding: 0
        }

        thead tr {
            margin: 0;
            padding: 0
        }

        th {
            background: var(--surface2);
            padding: 9px 8px;
            text-align: left;
            font-family: var(--mono);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: .5px;
            color: var(--text-dim);
            border-bottom: 2px solid var(--border);
            cursor: pointer;
            white-space: nowrap;
            user-select: none;
            margin: 0
        }

        th:hover {
            color: var(--accent)
        }

        th.sd {
            color: var(--accent)
        }

        th.sd::after {
            content: ' ▼';
            font-size: 8px
        }

        th.sd.asc::after {
            content: ' ▲'
        }

        tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background .1s
        }

        tbody tr:hover {
            background: var(--surface2)
        }

        td {
            padding: 8px 8px;
            white-space: nowrap
        }

        .tk {
            font-weight: 700;
            font-size: 14px
        }

        .tn {
            color: var(--text-dim);
            font-size: 11px;
            max-width: 130px;
            overflow: hidden;
            text-overflow: ellipsis
        }

        .sb {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            font-family: var(--mono);
            font-size: 12px;
            font-weight: 600
        }

        .sf {
            height: 5px;
            border-radius: 3px;
            min-width: 3px
        }

        .cp {
            font-family: var(--mono);
            font-weight: 700;
            font-size: 13px
        }

        .mb {
            font-family: var(--mono);
            font-size: 10px;
            padding: 2px 7px;
            border-radius: 12px;
            font-weight: 600
        }

        .mh {
            background: rgba(248, 113, 113, .12);
            color: var(--red)
        }

        .mw {
            background: rgba(251, 146, 60, .12);
            color: var(--orange)
        }

        .mc {
            background: rgba(96, 165, 250, .12);
            color: var(--blue)
        }

        .mf {
            background: rgba(74, 85, 104, .2);
            color: var(--text-faint)
        }

        .up {
            color: var(--green);
            font-weight: 700
        }

        .dn {
            color: var(--red);
            font-weight: 700
        }

        .nu {
            color: var(--text-dim)
        }

        .fl {
            font-size: 11px;
            margin-right: 2px;
            display: inline-flex;
            vertical-align: middle
        }

        .fl svg, .mb svg, .st svg {
            display: inline-block;
            vertical-align: middle
        }

        .dr td {
            padding: 0 !important
        }

        .dc {
            padding: 16px 24px;
            background: var(--bg);
            border-bottom: 2px solid var(--border);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px
        }

        .dg h4 {
            font-size: 10px;
            color: var(--text-faint);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: var(--mono);
            margin-bottom: 5px
        }

        .di {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            padding: 3px 0;
            border-bottom: 1px solid var(--border)
        }

        .dl {
            color: var(--text-dim)
        }

        .dv {
            font-family: var(--mono);
            font-weight: 600
        }

        .ld {
            text-align: center;
            padding: 80px 24px;
            color: var(--text-dim)
        }

        .sp {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin .8s linear infinite;
            margin: 0 auto 16px
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        .em {
            text-align: center;
            padding: 80px 24px;
            color: var(--text-dim)
        }

        .mcap-slider {
            -webkit-appearance: none;
            appearance: none;
            flex: 1;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            outline: none;
            cursor: pointer
        }

        .mcap-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: 2px solid var(--surface)
        }

        .mcap-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: 2px solid var(--surface)
        }

        .ext-btn {
            display: inline-flex;
            align-items: center;
            text-decoration: none;
            font-family: var(--font);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap
        }

        .yf-btn {
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            background: #0f0b2e;
            border: 1px solid #1e1b4b;
            color: #a78bfa;
            font-size: 12px
        }

        .yf-btn:hover {
            background: #1e1b4b;
            border-color: #6d28d9
        }

        .yf-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            color: white;
            font-size: 11px;
            font-weight: 700
        }

        .sec-btn {
            gap: 6px;
            padding: 6px 14px;
            border-radius: 6px;
            background: rgba(34,197,94,0.06);
            border: 1px solid rgba(34,197,94,0.2);
            color: #4ade80;
            font-size: 12px;
            letter-spacing: 0.3px
        }

        .sec-btn:hover {
            background: rgba(34,197,94,0.15)
        }

        /* ===== Chart Panel ===== */
        .chart-tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid var(--border);
            background: var(--surface);
            overflow-x: auto;
            scrollbar-width: none
        }

        .chart-tabs::-webkit-scrollbar {
            display: none
        }

        .chart-tab {
            padding: 10px 18px;
            font-size: 12px;
            font-family: var(--mono);
            color: var(--text-dim);
            cursor: pointer;
            white-space: nowrap;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: color .15s, border-color .15s;
            user-select: none
        }

        .chart-tab:hover {
            color: var(--text)
        }

        .chart-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
            font-weight: 600
        }

        .chart-body {
            padding: 16px 24px;
            background: var(--bg);
            min-height: 320px;
            position: relative
        }

        .chart-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            color: var(--text-dim);
            font-family: var(--mono);
            font-size: 12px;
            gap: 10px
        }

        .chart-loading .sp {
            width: 20px;
            height: 20px;
            margin: 0
        }

        .chart-error {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            color: var(--red);
            font-family: var(--mono);
            font-size: 12px
        }

        .chart-nodata {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            color: var(--text-faint);
            font-family: var(--mono);
            font-size: 12px
        }

        .chart-wrap {
            width: 100%;
            height: 400px;
            position: relative
        }

        .chart-wrap canvas {
            max-width: 100% !important
        }

        .ind-bar {
            display: flex;
            gap: 6px;
            padding: 8px 0;
            flex-wrap: wrap
        }

        .ind-btn {
            padding: 4px 10px;
            font-size: 11px;
            font-family: var(--mono);
            border: 1px solid var(--border);
            border-radius: 12px;
            background: transparent;
            color: var(--text-dim);
            cursor: pointer;
            transition: all .15s
        }

        .ind-btn:hover {
            border-color: var(--accent);
            color: var(--accent)
        }

        .ind-btn.on {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent)
        }

        /* Summary grid inside chart panel */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px
        }

        @media(max-width:768px) {
            .header {
                padding: 10px 14px
            }

            .toolbar {
                padding: 10px 14px
            }

            .sbar {
                padding: 6px 14px;
                font-size: 10px
            }

            .tw {
                padding: 0 6px 80px
            }

            th,
            td {
                padding: 6px 5px;
                font-size: 11px
            }

            .dc {
                grid-template-columns: 1fr 1fr
            }

            .chart-tab {
                padding: 8px 12px;
                font-size: 11px
            }

            .chart-body {
                padding: 12px 10px
            }

            .chart-wrap {
                height: 300px
            }

            .summary-grid {
                grid-template-columns: 1fr
            }
        }
    </style>
</head>

<body data-theme="dark">
    <div class="header">
        <div class="logo"><span>SEE</span><span>SAW</span><svg class="seesaw-icon" width="32" height="11" viewBox="0 0 100 35" fill="var(--accent)" style="margin-left:6px;margin-right:2px;vertical-align:middle"><polygon points="5,0 40,11 40,22 5,19"/><polygon points="60,13 95,16 95,35 60,24"/><circle cx="50" cy="17" r="6"/></svg><span
                style="font-weight:300;font-size:14px;color:var(--text-dim);margin-left:4px">MFSES</span></div>
        <div class="header-r">
            <div class="hbadge" id="upd" style="background:rgba(34,211,238,.1);color:var(--text-dim)">Updated: —</div>
            <div class="hbadge" id="hb">● Loading...</div><button class="tbtn" onclick="toggleTheme()">◐</button>
        </div>
    </div>
    <div class="toolbar">
        <input type="text" class="sbox" id="q" placeholder="Search ticker or company...">
        <div style="display:flex;align-items:center;gap:18px;margin-left:auto;font-family:var(--mono);font-size:11px;color:var(--text-dim)">
            <div class="st">Stocks: <span class="sv" id="sT">—</span></div>
            <div class="st">Showing: <span class="sv" id="sS">—</span></div>
            <div class="st" id="siH"></div><div class="st"><span class="sv" style="color:var(--red)" id="sH">—</span></div>
            <div class="st" id="siW"></div><div class="st"><span class="sv" style="color:var(--orange)" id="sW">—</span></div>
            <div class="st" id="siC"></div><div class="st"><span class="sv" style="color:var(--blue)" id="sC">—</span></div>
            <div class="st" id="siF"></div><div class="st"><span class="sv" style="color:var(--text-faint)" id="sF">—</span></div>
            <div class="st" id="siK"></div><div class="st"><span class="sv" id="sK">—</span></div>
        </div>
    </div>
    <div class="sbar" id="sb">
        <div class="tg"><span class="tl">Sector</span><select class="fsel" id="fSec">
                <option value="">All</option>
                <option>Technology</option>
                <option>Healthcare</option>
                <option>Financials</option>
                <option>Consumer</option>
                <option>Consumer Staples</option>
                <option>Energy</option>
                <option>Industrials</option>
                <option>Utilities</option>
                <option>Communication</option>
                <option>Real Estate</option>
                <option>Materials</option>
            </select></div>
        <div class="tg"><span class="tl">Tier</span><select class="fsel" id="fTier">
                <option value="">All</option>
                <option value="1">Mega</option>
                <option value="2">Large</option>
                <option value="3">Mid</option>
                <option value="4">Small</option>
            </select></div>
        <div class="tg"><span class="tl">State</span><select class="fsel" id="fSt">
                <option value="">All</option>
                <option value="HOT">◆ HOT</option>
                <option value="WARM">◇ WARM</option>
                <option value="COLD">○ COLD</option>
                <option value="FROZEN">✦ FROZEN</option>
            </select></div>
        <div class="tg"><span class="tl">Value</span><select class="fsel" id="fVal">
                <option value="">All</option>
                <option value="u">Under (>20%↑)</option>
                <option value="f">Fair (±10%)</option>
                <option value="o">Over (>20%↓)</option>
            </select></div>
        <div class="tg"><span class="tl">Flags</span><select class="fsel" id="fFlg">
                <option value="">All</option>
                <option value="t">♛ Triple Crown</option>
                <option value="v">△ Value Trap</option>
                <option value="e">⚡ Exp Growth</option>
            </select></div>
        <div class="tg"><span class="tl">Sort</span><select class="fsel" id="srt">
                <option value="mfses_short-d">Short ↓</option>
                <option value="mfses_mid-d">Mid ↓</option>
                <option value="mfses_long-d">Long ↓</option>
                <option value="total_score-d">Total ↓</option>
                <option value="graham_upside_pct-d">Upside ↓</option>
                <option value="dividend_yield-d">Yield ↓</option>
                <option value="market_cap-d">MCap ↓</option>
                <option value="price_change_pct-d">Chg% ↓</option>
                <option value="volume_ratio-d">VolR ↓</option>
                <option value="ticker-a">A→Z</option>
            </select></div>
        <div class="tg" style="min-width:120px;max-width:180px"><span class="tl">MCap</span>
            <span class="sv" id="mcL" style="font-size:10px;color:var(--text-faint);min-width:35px">All</span>
            <input type="range" id="mcSlider" min="0" max="5" value="0" class="mcap-slider" style="width:60px">
            <span class="sv" id="mcV" style="font-size:10px;color:var(--text-faint)">∞</span>
        </div>
    </div>
    <div class="tw">
        <div class="ld" id="ldg">
            <div class="sp"></div>
            <div>Loading stocks from Supabase...</div>
        </div>
        <table id="tbl" style="display:none">
            <thead>
                <tr>
                    <th data-c="ticker">Ticker</th>
                    <th data-c="price">Price</th>
                    <th data-c="price_change_pct">Chg%</th>
                    <th data-c="markov_state">State</th>
                    <th data-c="moat_score">Moat</th>
                    <th data-c="growth_score">Grw</th>
                    <th data-c="balance_score">Bal</th>
                    <th data-c="valuation_score">Val</th>
                    <th data-c="sentiment_score">Sen</th>
                    <th data-c="dividend_score">Div</th>
                    <th data-c="total_score">Tot</th>
                    <th data-c="mfses_short">Short</th>
                    <th data-c="mfses_mid">Mid</th>
                    <th data-c="mfses_long">Long</th>
                    <th data-c="graham_upside_pct">Upside</th>
                    <th data-c="dividend_yield">Yield</th>
                </tr>
            </thead>
            <tbody id="tb"></tbody>
        </table>
        <div class="em" id="emp" style="display:none">No stocks match your filters.</div>
    </div>
    <script>
        // ============ CONFIG — UPDATE THESE ============
        const SB_URL = 'https://isnuktzlqeeivhbwykxs.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlzbnVrdHpscWVlaXZoYnd5a3hzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwODMwODYsImV4cCI6MjA4NTY1OTA4Nn0.3u6IDfRFChaHyQ3yIharGHaVicNjgJAaPvX-vGr2N3Q';

        // ============ SVG ICONS ============
        function icon(name, size = 14, color = 'currentColor') {
            const s = `width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"`;
            const icons = {
                hot: `<svg ${s}><path d="M12 22c-4.97 0-9-2.69-9-6 0-4 5-11 9-14 4 3 9 10 9 14 0 3.31-4.03 6-9 6z"/><path d="M12 22c-1.66 0-3-1.12-3-2.5 0-2 3-5.5 3-5.5s3 3.5 3 5.5c0 1.38-1.34 2.5-3 2.5z" fill="${color}" opacity="0.3"/></svg>`,
                warm: `<svg ${s}><path d="M4 10c1.5-1.5 3.5-1.5 5 0s3.5 1.5 5 0 3.5-1.5 5 0"/><path d="M4 16c1.5-1.5 3.5-1.5 5 0s3.5 1.5 5 0 3.5-1.5 5 0"/></svg>`,
                cold: `<svg ${s}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>`,
                frozen: `<svg ${s}><line x1="12" y1="2" x2="12" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/><line x1="19.07" y1="4.93" x2="4.93" y2="19.07"/><circle cx="12" cy="12" r="3" stroke-width="1.5"/></svg>`,
                crown: `<svg ${s}><path d="M2 20h20L19 8l-4 5-3-7-3 7L5 8z"/><line x1="2" y1="20" x2="22" y2="20" stroke-width="2.5"/></svg>`,
                warning: `<svg ${s}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><circle cx="12" cy="17" r="0.5" fill="${color}"/></svg>`,
                bolt: `<svg ${s}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`
            };
            return icons[name] || '';
        }
        const STATE_ICONS = { HOT: 'hot', WARM: 'warm', COLD: 'cold', FROZEN: 'frozen' };
        const STATE_COLORS = { HOT: 'var(--red)', WARM: 'var(--orange)', COLD: 'var(--blue)', FROZEN: 'var(--text-faint)' };

        let A = [], F = [], S = { c: 'mfses_short', d: 'desc' }, EX = null, RC = 0, BS = 100;

        async function load() {
            try {
                const r = await fetch(`${SB_URL}/rest/v1/dashboard_stocks?select=*&order=mfses_short.desc.nullslast`, { headers: { 'apikey': SB_KEY, 'Authorization': `Bearer ${SB_KEY}`, 'Range': '0-2999' } });
                if (!r.ok) throw new Error(`HTTP ${r.status}`); A = await r.json();
                $('ldg').style.display = 'none'; $('tbl').style.display = ''; stats(); af();
                // Show data freshness from stock data itself
                const latest = A.reduce((best, s) => {
                    const t = s.scored_at || s.collected_at;
                    return t && (!best || t > best) ? t : best;
                }, null);
                if (latest) {
                    const dt = new Date(latest); $('upd').textContent = `Updated: ${dt.toLocaleDateString()} ${dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`;
                    const ageH = (Date.now() - dt.getTime()) / 3.6e6, b = $('hb');
                    if (ageH < 1) { b.textContent = '● Live'; b.style.color = 'var(--green)' }
                    else if (ageH < 24) { b.textContent = `● ${Math.floor(ageH)}h ago`; b.style.color = 'var(--yellow)' }
                    else { b.textContent = `● ${Math.floor(ageH / 24)}d old`; b.style.color = 'var(--orange)' }
                } else { $('hb').textContent = '● No data'; $('hb').style.color = 'var(--text-faint)' }
                // Also check system_health for pipeline status
                fetch(`${SB_URL}/rest/v1/system_health?select=*`, { headers: { 'apikey': SB_KEY, 'Authorization': `Bearer ${SB_KEY}` } }).then(r => r.json()).then(d => { if (d && d[0]) { const h = d[0], b = $('hb'); b.textContent = `● ${h.last_run_status === 'success' ? 'Healthy' : h.last_run_status || '?'}`; b.style.color = h.last_run_status === 'success' ? 'var(--green)' : 'var(--red)'; if (h.last_run_at) { const dt = new Date(h.last_run_at); $('upd').textContent = `Updated: ${dt.toLocaleDateString()} ${dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}` } } }).catch(() => { });
            } catch (e) { $('ldg').innerHTML = `<div style="color:var(--red)">${icon('warning', 16, 'var(--red)')} ${e.message}</div><div style="margin-top:8px;font-size:12px;color:var(--text-faint)">Update SB_URL and SB_KEY in index.html</div>` }
        }

        function af() {
            const q = $('q').value.toLowerCase(), sec = $('fSec').value, tier = $('fTier').value, st = $('fSt').value, vl = $('fVal').value, fl = $('fFlg').value, mcMin = MC_STEPS[+$('mcSlider').value];
            F = A.filter(s => {
                if (q && !s.ticker?.toLowerCase().includes(q) && !s.company_name?.toLowerCase().includes(q)) return false;
                if (sec && s.sector !== sec) return false; if (tier && s.tier != tier) return false; if (st && s.markov_state !== st) return false;
                if (mcMin && (+s.market_cap || 0) < mcMin) return false;
                if (vl === 'u' && (s.graham_upside_pct == null || s.graham_upside_pct < 20)) return false;
                if (vl === 'f' && (s.graham_upside_pct == null || Math.abs(s.graham_upside_pct) > 10)) return false;
                if (vl === 'o' && (s.graham_upside_pct == null || s.graham_upside_pct > -20)) return false;
                if (fl === 't' && !s.is_triple_crown) return false; if (fl === 'v' && !s.is_value_trap) return false; if (fl === 'e' && !s.is_expensive_growth) return false;
                return true
            }); ss(); RC = 0; render(); $('sS').textContent = F.length
        }

        function ss() { const { c, d } = S; F.sort((a, b) => { let x = a[c], y = b[c]; if (x == null && y == null) return 0; if (x == null) return 1; if (y == null) return -1; if (c === 'ticker' || c === 'markov_state') return d === 'asc' ? String(x).localeCompare(String(y)) : String(y).localeCompare(String(x)); x = +x || 0; y = +y || 0; return d === 'asc' ? x - y : y - x }) }

        function setS(c) { if (S.c === c) S.d = S.d === 'desc' ? 'asc' : 'desc'; else { S.c = c; S.d = 'desc' } document.querySelectorAll('th').forEach(t => { t.classList.remove('sd', 'asc'); if (t.dataset.c === c) { t.classList.add('sd'); if (S.d === 'asc') t.classList.add('asc') } }); ss(); RC = 0; render() }

        function render() { const tb = $('tb'), em = $('emp'); if (!F.length) { tb.innerHTML = ''; em.style.display = ''; return } em.style.display = 'none'; if (!RC) tb.innerHTML = ''; const e = Math.min(RC + BS, F.length), fg = document.createDocumentFragment(); for (let i = RC; i < e; i++)fg.appendChild(mkr(F[i])); tb.appendChild(fg); RC = e }

        function mkr(s) {
            const tr = document.createElement('tr'); tr.onclick = () => togD(s.ticker, tr);
            const p = s.price ? `$${(+s.price).toFixed(2)}` : '—'; const ch = s.price_change_pct != null ? (+s.price_change_pct).toFixed(2) : '—'; const cc = +s.price_change_pct > 0 ? 'up' : +s.price_change_pct < 0 ? 'dn' : '';
            const mc = { HOT: 'mh', WARM: 'mw', COLD: 'mc', FROZEN: 'mf' }, ms = s.markov_state || 'COLD';
            const si = icon(STATE_ICONS[ms], 12, STATE_COLORS[ms]);
            const us = s.graham_upside_pct != null ? (+s.graham_upside_pct).toFixed(1) + '%' : '—', uc = +s.graham_upside_pct > 0 ? 'up' : +s.graham_upside_pct < 0 ? 'dn' : 'nu';
            const dy = s.dividend_yield ? (+s.dividend_yield).toFixed(2) + '%' : '—';
            let fl = ''; if (s.is_triple_crown) fl += `<span class="fl" title="Triple Crown">${icon('crown', 11, 'var(--yellow)')}</span>`; if (s.is_value_trap) fl += `<span class="fl" title="Value Trap">${icon('warning', 11, 'var(--red)')}</span>`; if (s.is_expensive_growth) fl += `<span class="fl" title="Exp Growth">${icon('bolt', 11, 'var(--accent)')}</span>`;
            tr.innerHTML = `<td><div class="tk">${fl}${s.ticker}</div><div class="tn">${s.company_name || ''}</div></td>
<td style="font-family:var(--mono);font-size:12px">${p}</td><td class="${cc}" style="font-family:var(--mono);font-size:12px">${ch}%</td>
<td><span class="mb ${mc[ms]}">${si} ${ms}</span></td>
<td>${sc(s.moat_score, '--accent')}</td><td>${sc(s.growth_score, '--accent2')}</td><td>${sc(s.balance_score, '--green')}</td><td>${sc(s.valuation_score, '--orange')}</td><td>${sc(s.sentiment_score, '--pink')}</td><td>${sc(s.dividend_score, '--yellow')}</td>
<td><span class="cp" style="color:${tc(s.total_score)}">${s.total_score ?? '—'}</span></td>
<td><span class="cp" style="color:${cc2(s.mfses_short)}">${s.mfses_short != null ? (+s.mfses_short).toFixed(1) : '—'}</span></td>
<td><span class="cp" style="color:${cc2(s.mfses_mid)}">${s.mfses_mid != null ? (+s.mfses_mid).toFixed(1) : '—'}</span></td>
<td><span class="cp" style="color:${cc2(s.mfses_long)}">${s.mfses_long != null ? (+s.mfses_long).toFixed(1) : '—'}</span></td>
<td class="${uc}" style="font-family:var(--mono);font-size:12px">${us}</td><td style="font-family:var(--mono);font-size:12px">${dy}</td>`; return tr
        }

        function sc(v, c) { if (v == null) return '<span style="color:var(--text-faint)">—</span>'; return `<span class="sb"><span class="sf" style="width:${v / 20 * 40}px;background:var(${c})"></span>${v}</span>` }
        function cc2(v) { if (v == null) return 'var(--text-faint)'; if (v >= 16) return 'var(--green)'; if (v >= 13) return 'var(--accent)'; if (v >= 10) return 'var(--yellow)'; if (v >= 7) return 'var(--orange)'; return 'var(--red)' }
        function tc(v) { if (v == null) return 'var(--text-faint)'; if (v >= 90) return 'var(--green)'; if (v >= 72) return 'var(--accent)'; if (v >= 60) return 'var(--yellow)'; if (v >= 48) return 'var(--orange)'; return 'var(--red)' }

        // ============ CHART SYSTEM ============
        const PG_KEY = 'FzNPP96rxiDhDz3xTQYB31Ucrek54q7x';
        const CHART_CACHE = {}; // In-memory cache {ticker: {data, ts}}
        const CACHE_TTL = 30 * 60 * 1000; // 30 min
        let activeChart = null; // Lightweight Charts instance
        let activeChartJS = []; // Chart.js instances
        const TABS = ['Summary', 'Price', 'Income', 'Cash Flow', 'Growth', 'Margins', 'Allocation'];

        function cleanupCharts() {
            if (activeChart) { try { activeChart.remove() } catch(e){} activeChart = null; }
            activeChartJS.forEach(c => { try { c.destroy() } catch(e){} });
            activeChartJS = [];
        }

        function togD(tk, tr) {
            const ex = document.querySelector('.dr');
            if (ex) { cleanupCharts(); ex.remove(); if (EX === tk) { EX = null; return } }
            EX = tk; const s = F.find(x => x.ticker === tk); if (!s) return;
            const d = document.createElement('tr'); d.className = 'dr';
            d.innerHTML = `<td colspan="16"><div class="chart-tabs">${TABS.map((t,i) =>
                `<div class="chart-tab${i===0?' active':''}" data-tab="${t}">${t}</div>`).join('')}</div><div class="chart-body" id="cbody"></div></td>`;
            tr.after(d);
            d.querySelectorAll('.chart-tab').forEach(tab => tab.onclick = () => {
                d.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                switchTab(tab.dataset.tab, tk, s);
            });
            switchTab('Summary', tk, s);
        }

        function switchTab(tab, tk, s) {
            cleanupCharts();
            const body = document.getElementById('cbody');
            if (!body) return;
            if (tab === 'Summary') { renderSummary(body, tk, s); return; }
            body.innerHTML = '<div class="chart-loading"><div class="sp"></div>Loading chart data...</div>';
            fetchChartData(tk).then(data => {
                if (EX !== tk) return;
                const b = document.getElementById('cbody');
                if (!b) return;
                switch(tab) {
                    case 'Price': renderPriceChart(b, data, tk); break;
                    case 'Income': renderIncomeChart(b, data); break;
                    case 'Cash Flow': renderCashFlowChart(b, data); break;
                    case 'Growth': renderGrowthChart(b, data); break;
                    case 'Margins': renderMarginsChart(b, data); break;
                    case 'Allocation': renderAllocationChart(b, data); break;
                }
            }).catch(err => {
                const b = document.getElementById('cbody');
                if (b) b.innerHTML = `<div class="chart-error">Failed to load data: ${err.message}</div>`;
            });
        }

        function renderSummary(body, tk, s) {
            body.innerHTML = `<div class="summary-grid">
<div class="dg"><h4>Graham Valuation</h4><div class="di"><span class="dl">Graham Value</span><span class="dv">$${s.graham_value ? (+s.graham_value).toFixed(2) : '—'}</span></div><div class="di"><span class="dl">Price</span><span class="dv">$${s.price ? (+s.price).toFixed(2) : '—'}</span></div><div class="di"><span class="dl">Upside</span><span class="dv ${+s.graham_upside_pct > 0 ? 'up' : 'dn'}">${s.graham_upside_pct != null ? (+s.graham_upside_pct).toFixed(1) + '%' : '—'}</span></div><div style="display:flex;align-items:center;gap:10px;margin-top:12px"><a href="https://finance.yahoo.com/quote/${tk}/" target="_blank" rel="noopener noreferrer" class="ext-btn yf-btn"><span class="yf-badge">Y!</span>Yahoo Finance<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="opacity:0.5"><path d="M7 17L17 7M17 7H7M17 7v10"/></svg></a><a href="https://www.sec.gov/cgi-bin/browse-edgar?action=getcompany&company=${tk}&type=10-K&dateb=&owner=include&count=10" target="_blank" rel="noopener noreferrer" class="ext-btn sec-btn"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>SEC Filings<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M7 17L17 7M17 7H7M17 7v10"/></svg></a></div></div>
<div class="dg"><h4>Earnings</h4><div class="di"><span class="dl">EPS</span><span class="dv">$${s.eps_current ? (+s.eps_current).toFixed(2) : '—'}</span></div><div class="di"><span class="dl">Growth</span><span class="dv">${s.eps_growth_rate != null ? (+s.eps_growth_rate).toFixed(1) + '%' : '—'}</span></div><div class="di"><span class="dl">D/E</span><span class="dv">${s.debt_to_equity != null ? (+s.debt_to_equity).toFixed(2) : '—'}</span></div></div>
<div class="dg"><h4>Dividends</h4><div class="di"><span class="dl">Annual</span><span class="dv">$${s.annual_dividend ? (+s.annual_dividend).toFixed(2) : '—'}</span></div><div class="di"><span class="dl">Yield</span><span class="dv">${s.dividend_yield ? (+s.dividend_yield).toFixed(2) + '%' : '—'}</span></div><div class="di"><span class="dl">Payout</span><span class="dv">${s.payout_ratio ? (+s.payout_ratio).toFixed(1) + '%' : '—'}</span></div><div class="di"><span class="dl">5yr Grw</span><span class="dv">${s.dividend_growth_5yr ? (+s.dividend_growth_5yr).toFixed(1) + '%' : '—'}</span></div><div class="di"><span class="dl">Consec</span><span class="dv">${s.consecutive_increases ?? '—'} yrs</span></div><div class="di"><span class="dl">Ex-Div</span><span class="dv">${s.ex_dividend_date || '—'}</span></div></div>
<div class="dg"><h4>Market Data</h4><div class="di"><span class="dl">Market Cap</span><span class="dv">${fmc(s.market_cap)}</span></div><div class="di"><span class="dl">Volume</span><span class="dv">${s.volume ? (+s.volume).toLocaleString() : '—'}</span></div><div class="di"><span class="dl">Vol Ratio</span><span class="dv">${s.volume_ratio ? (+s.volume_ratio).toFixed(2) + 'x' : '—'}</span></div><div class="di"><span class="dl">Sector</span><span class="dv">${s.sector || '—'}</span></div><div class="di"><span class="dl">Tier</span><span class="dv">${['', 'Mega', 'Large', 'Mid', 'Small'][s.tier] || '—'}</span></div><div class="di"><span class="dl">Quality</span><span class="dv">${s.data_quality_score ?? '—'}%</span></div></div>
</div>`;
        }

        // ============ DATA FETCHING LAYER ============
        async function fetchChartData(ticker) {
            // 1. In-memory cache
            if (CHART_CACHE[ticker] && (Date.now() - CHART_CACHE[ticker].ts < CACHE_TTL)) {
                return CHART_CACHE[ticker].data;
            }
            // 2. Supabase cache
            try {
                const r = await fetch(`${SB_URL}/rest/v1/stock_financials_cache?ticker=eq.${ticker}&expires_at=gt.${new Date().toISOString()}`, {
                    headers: { 'apikey': SB_KEY, 'Authorization': `Bearer ${SB_KEY}` }
                });
                const rows = await r.json();
                if (rows && rows.length && rows[0].income_data) {
                    const data = { income: rows[0].income_data, cashflow: rows[0].cashflow_data, balance: rows[0].balance_data, bars: rows[0].price_bars };
                    CHART_CACHE[ticker] = { data, ts: Date.now() };
                    return data;
                }
            } catch(e) { /* cache miss, continue */ }
            // 3. Fetch from Polygon
            const data = await fetchFromPolygon(ticker);
            CHART_CACHE[ticker] = { data, ts: Date.now() };
            // 4. Write to Supabase cache (fire-and-forget)
            try {
                fetch(`${SB_URL}/rest/v1/stock_financials_cache`, {
                    method: 'POST',
                    headers: { 'apikey': SB_KEY, 'Authorization': `Bearer ${SB_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'resolution=merge-duplicates' },
                    body: JSON.stringify({ ticker, income_data: data.income, cashflow_data: data.cashflow, balance_data: data.balance, price_bars: data.bars, cached_at: new Date().toISOString(), expires_at: new Date(Date.now() + 7*24*60*60*1000).toISOString() })
                });
            } catch(e) { /* cache write failed, non-critical */ }
            return data;
        }

        async function fetchFromPolygon(ticker) {
            const [finRes, barRes] = await Promise.all([
                fetch(`https://api.polygon.io/vX/reference/financials?ticker=${ticker}&limit=5&sort=period_of_report_date&order=desc&apiKey=${PG_KEY}`),
                fetch(`https://api.polygon.io/v2/aggs/ticker/${ticker}/range/1/day/${dateStr(-730)}/${dateStr(0)}?adjusted=true&sort=asc&limit=730&apiKey=${PG_KEY}`)
            ]);
            const fin = await finRes.json();
            const bar = await barRes.json();
            const income = [], cashflow = [], balance = [];
            if (fin.results) {
                for (const r of fin.results) {
                    const period = r.fiscal_period || '';
                    const year = r.fiscal_year || '';
                    const label = `${period} ${year}`;
                    if (r.financials?.income_statement) {
                        const is = r.financials.income_statement;
                        income.push({ label, year, revenue: is.revenues?.value, gross_profit: is.gross_profit?.value, op_income: is.operating_income_loss?.value, net_income: is.net_income_loss?.value, cost_of_revenue: is.cost_of_revenue?.value, op_expenses: is.operating_expenses?.value, eps: is.basic_earnings_per_share?.value });
                    }
                    if (r.financials?.cash_flow_statement) {
                        const cf = r.financials.cash_flow_statement;
                        cashflow.push({ label, year, operating: cf.net_cash_flow_from_operating_activities?.value, investing: cf.net_cash_flow_from_investing_activities?.value, financing: cf.net_cash_flow_from_financing_activities?.value, capex: cf.net_cash_flow_from_investing_activities_continuing?.value });
                    }
                    if (r.financials?.balance_sheet) {
                        const bs = r.financials.balance_sheet;
                        balance.push({ label, year, total_assets: bs.assets?.value, total_liabilities: bs.liabilities?.value, equity: bs.equity?.value, current_assets: bs.current_assets?.value, current_liabilities: bs.current_liabilities?.value });
                    }
                }
            }
            const bars = (bar.results || []).map(b => ({ t: b.t, o: b.o, h: b.h, l: b.l, c: b.c, v: b.v, vw: b.vw }));
            return { income: income.reverse(), cashflow: cashflow.reverse(), balance: balance.reverse(), bars };
        }

        function dateStr(offsetDays) {
            const d = new Date(); d.setDate(d.getDate() + offsetDays);
            return d.toISOString().split('T')[0];
        }

        // ============ CHART.JS THEME HELPERS ============
        function isDark() { return document.body.dataset.theme !== 'light'; }
        function cjsColors() {
            const dk = isDark();
            return {
                text: dk ? '#9ca3b8' : '#5a6178', grid: dk ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.06)',
                green: '#22c55e', red: '#ef4444', blue: '#3b82f6', orange: '#f97316', purple: '#a855f7', yellow: '#eab308', cyan: '#06b6d4', pink: '#ec4899',
                bg: dk ? '#0a0c10' : '#f5f6fa', surface: dk ? '#12151c' : '#ffffff'
            };
        }

        function cjsOpts(title, yFmt) {
            const c = cjsColors();
            return {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: c.text, font: { family: "'JetBrains Mono', monospace", size: 11 } } },
                    title: { display: !!title, text: title, color: c.text, font: { family: "'Outfit', sans-serif", size: 14, weight: 600 } },
                    tooltip: { callbacks: { label: ctx => { const v = ctx.parsed.y ?? ctx.parsed; return `${ctx.dataset.label}: ${yFmt ? yFmt(v) : fmtNum(v)}` } } }
                },
                scales: {
                    x: { ticks: { color: c.text, font: { size: 10 } }, grid: { color: c.grid } },
                    y: { ticks: { color: c.text, font: { size: 10 }, callback: v => yFmt ? yFmt(v) : fmtNum(v) }, grid: { color: c.grid } }
                }
            };
        }

        function fmtNum(v) { if (v == null) return '—'; const a = Math.abs(v); if (a >= 1e12) return (v/1e12).toFixed(1)+'T'; if (a >= 1e9) return (v/1e9).toFixed(1)+'B'; if (a >= 1e6) return (v/1e6).toFixed(1)+'M'; if (a >= 1e3) return (v/1e3).toFixed(1)+'K'; return v.toFixed(1); }
        function fmtDollar(v) { return '$' + fmtNum(v); }
        function fmtPct(v) { return (v != null ? v.toFixed(1) : '—') + '%'; }

        // ============ PRICE CHART (Lightweight Charts) ============
        function renderPriceChart(body, data, ticker) {
            if (!data.bars || !data.bars.length) { body.innerHTML = '<div class="chart-nodata">No price data available</div>'; return; }
            const dk = isDark();
            body.innerHTML = `<div class="ind-bar" id="indBar"></div><div class="chart-wrap" id="priceWrap"></div>`;
            const wrap = document.getElementById('priceWrap');
            const chart = LightweightCharts.createChart(wrap, {
                width: wrap.clientWidth, height: wrap.clientHeight,
                layout: { background: { type: 'solid', color: 'transparent' }, textColor: dk ? '#9ca3b8' : '#5a6178', fontFamily: "'JetBrains Mono', monospace", fontSize: 10 },
                grid: { vertLines: { color: dk ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.04)' }, horzLines: { color: dk ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.04)' } },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                rightPriceScale: { borderColor: dk ? '#1a1e28' : '#e2e5ee' },
                timeScale: { borderColor: dk ? '#1a1e28' : '#e2e5ee', timeVisible: false }
            });
            activeChart = chart;

            const candleData = data.bars.map(b => ({ time: Math.floor(b.t / 1000), open: b.o, high: b.h, low: b.l, close: b.c }));
            const volData = data.bars.map(b => ({ time: Math.floor(b.t / 1000), value: b.v, color: b.c >= b.o ? 'rgba(34,197,94,0.3)' : 'rgba(239,68,68,0.3)' }));

            const candleSeries = chart.addCandlestickSeries({ upColor: '#22c55e', downColor: '#ef4444', borderDownColor: '#ef4444', borderUpColor: '#22c55e', wickDownColor: '#ef4444', wickUpColor: '#22c55e' });
            candleSeries.setData(candleData);

            const volSeries = chart.addHistogramSeries({ priceFormat: { type: 'volume' }, priceScaleId: 'vol' });
            chart.priceScale('vol').applyOptions({ scaleMargins: { top: 0.8, bottom: 0 } });
            volSeries.setData(volData);

            chart.timeScale().fitContent();

            // Indicator state
            const indicators = {};
            const indSeries = {};
            const closes = data.bars.map(b => b.c);
            const times = data.bars.map(b => Math.floor(b.t / 1000));

            function addLine(key, vals, color, title, paneId) {
                const lineData = []; for (let i = 0; i < vals.length; i++) { if (vals[i] != null) lineData.push({ time: times[i], value: vals[i] }); }
                if (paneId) {
                    const s = chart.addLineSeries({ color, lineWidth: 1, priceScaleId: paneId, title });
                    chart.priceScale(paneId).applyOptions({ scaleMargins: { top: 0.8, bottom: 0 } });
                    s.setData(lineData); indSeries[key] = s;
                } else {
                    const s = chart.addLineSeries({ color, lineWidth: 1, title });
                    s.setData(lineData); indSeries[key] = s;
                }
            }

            function removeLine(key) { if (indSeries[key]) { chart.removeSeries(indSeries[key]); delete indSeries[key]; } }

            function toggleInd(key) {
                indicators[key] = !indicators[key];
                if (!indicators[key]) { removeLine(key); if (key === 'BB') { removeLine('BBu'); removeLine('BBl'); } if (key === 'MACD') { removeLine('MACDs'); removeLine('MACDh'); } return; }
                switch(key) {
                    case 'SMA20': addLine(key, calcSMA(closes, 20), '#f97316', 'SMA 20'); break;
                    case 'SMA50': addLine(key, calcSMA(closes, 50), '#a855f7', 'SMA 50'); break;
                    case 'EMA12': addLine(key, calcEMA(closes, 12), '#3b82f6', 'EMA 12'); break;
                    case 'EMA26': addLine(key, calcEMA(closes, 26), '#ec4899', 'EMA 26'); break;
                    case 'BB': {
                        const bb = calcBollinger(closes, 20);
                        addLine(key, bb.mid, '#eab308', 'BB Mid');
                        addLine('BBu', bb.upper, 'rgba(234,179,8,0.4)', 'BB Upper');
                        addLine('BBl', bb.lower, 'rgba(234,179,8,0.4)', 'BB Lower');
                        break;
                    }
                    case 'RSI': addLine(key, calcRSI(closes, 14), '#06b6d4', 'RSI', 'rsi'); break;
                    case 'MACD': {
                        const m = calcMACD(closes);
                        addLine(key, m.macd, '#3b82f6', 'MACD', 'macd');
                        addLine('MACDs', m.signal, '#f97316', 'Signal', 'macd');
                        break;
                    }
                    case 'VWAP': {
                        const vw = data.bars.map(b => b.vw).filter(v => v != null);
                        if (vw.length === data.bars.length) addLine(key, vw, '#22d3ee', 'VWAP');
                        else addLine(key, calcVWAP(data.bars), '#22d3ee', 'VWAP');
                        break;
                    }
                }
            }

            // Render indicator buttons
            const bar = document.getElementById('indBar');
            ['SMA20','SMA50','EMA12','EMA26','BB','RSI','MACD','VWAP'].forEach(key => {
                const btn = document.createElement('button');
                btn.className = 'ind-btn'; btn.textContent = key;
                btn.onclick = () => { toggleInd(key); btn.classList.toggle('on'); };
                bar.appendChild(btn);
            });

            // Resize observer
            const ro = new ResizeObserver(() => { chart.applyOptions({ width: wrap.clientWidth }); });
            ro.observe(wrap);
        }

        // ============ TECHNICAL INDICATOR CALCULATIONS ============
        function calcSMA(data, period) {
            const r = new Array(data.length).fill(null);
            for (let i = period - 1; i < data.length; i++) {
                let sum = 0; for (let j = i - period + 1; j <= i; j++) sum += data[j];
                r[i] = sum / period;
            } return r;
        }

        function calcEMA(data, period) {
            const r = new Array(data.length).fill(null);
            const k = 2 / (period + 1);
            let sum = 0; for (let i = 0; i < period; i++) sum += data[i];
            r[period - 1] = sum / period;
            for (let i = period; i < data.length; i++) r[i] = data[i] * k + r[i-1] * (1-k);
            return r;
        }

        function calcBollinger(data, period) {
            const mid = calcSMA(data, period);
            const upper = new Array(data.length).fill(null);
            const lower = new Array(data.length).fill(null);
            for (let i = period - 1; i < data.length; i++) {
                let sq = 0; for (let j = i - period + 1; j <= i; j++) sq += (data[j] - mid[i]) ** 2;
                const sd = Math.sqrt(sq / period);
                upper[i] = mid[i] + 2 * sd; lower[i] = mid[i] - 2 * sd;
            }
            return { mid, upper, lower };
        }

        function calcRSI(data, period) {
            const r = new Array(data.length).fill(null);
            let gains = 0, losses = 0;
            for (let i = 1; i <= period; i++) { const d = data[i] - data[i-1]; if (d > 0) gains += d; else losses -= d; }
            let avgG = gains / period, avgL = losses / period;
            r[period] = avgL === 0 ? 100 : 100 - 100 / (1 + avgG / avgL);
            for (let i = period + 1; i < data.length; i++) {
                const d = data[i] - data[i-1];
                avgG = (avgG * (period - 1) + (d > 0 ? d : 0)) / period;
                avgL = (avgL * (period - 1) + (d < 0 ? -d : 0)) / period;
                r[i] = avgL === 0 ? 100 : 100 - 100 / (1 + avgG / avgL);
            } return r;
        }

        function calcMACD(data) {
            const ema12 = calcEMA(data, 12), ema26 = calcEMA(data, 26);
            const macd = new Array(data.length).fill(null);
            for (let i = 25; i < data.length; i++) { if (ema12[i] != null && ema26[i] != null) macd[i] = ema12[i] - ema26[i]; }
            const macdVals = macd.filter(v => v != null);
            const sigRaw = calcEMA(macdVals, 9);
            const signal = new Array(data.length).fill(null);
            let idx = 0; for (let i = 0; i < data.length; i++) { if (macd[i] != null) { signal[i] = sigRaw[idx++]; } }
            return { macd, signal };
        }

        function calcVWAP(bars) {
            const r = []; let cumTPV = 0, cumVol = 0;
            for (const b of bars) {
                const tp = (b.h + b.l + b.c) / 3;
                cumTPV += tp * b.v; cumVol += b.v;
                r.push(cumVol ? cumTPV / cumVol : null);
            } return r;
        }

        // ============ FINANCIAL CHARTS (Chart.js) ============
        function renderIncomeChart(body, data) {
            if (!data.income || !data.income.length) { body.innerHTML = '<div class="chart-nodata">No income statement data available</div>'; return; }
            const c = cjsColors();
            body.innerHTML = '<div class="chart-wrap"><canvas id="incChart"></canvas></div>';
            const labels = data.income.map(d => d.label);
            const chart = new Chart(document.getElementById('incChart'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'Revenue', data: data.income.map(d => d.revenue), backgroundColor: c.blue },
                        { label: 'Gross Profit', data: data.income.map(d => d.gross_profit), backgroundColor: c.green },
                        { label: 'Operating Income', data: data.income.map(d => d.op_income), backgroundColor: c.orange },
                        { label: 'Net Income', data: data.income.map(d => d.net_income), backgroundColor: c.purple }
                    ]
                },
                options: cjsOpts('Income Statement', fmtDollar)
            });
            activeChartJS.push(chart);
        }

        function renderCashFlowChart(body, data) {
            if (!data.cashflow || !data.cashflow.length) { body.innerHTML = '<div class="chart-nodata">No cash flow data available</div>'; return; }
            const c = cjsColors();
            body.innerHTML = '<div class="chart-wrap"><canvas id="cfChart"></canvas></div>';
            const labels = data.cashflow.map(d => d.label);
            const fcf = data.cashflow.map(d => (d.operating || 0) + (d.capex || 0));
            const opts = cjsOpts('Cash Flow Statement', fmtDollar);
            opts.scales.y2 = { ...opts.scales.y, position: 'right', grid: { drawOnChartArea: false } };
            const chart = new Chart(document.getElementById('cfChart'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'Operating', data: data.cashflow.map(d => d.operating), backgroundColor: c.green },
                        { label: 'Investing', data: data.cashflow.map(d => d.investing), backgroundColor: c.orange },
                        { label: 'Financing', data: data.cashflow.map(d => d.financing), backgroundColor: c.blue },
                        { label: 'FCF', data: fcf, type: 'line', borderColor: c.cyan, backgroundColor: 'transparent', borderWidth: 2, borderDash: [5,3], pointRadius: 4, pointBackgroundColor: c.cyan, yAxisID: 'y2' }
                    ]
                },
                options: opts
            });
            activeChartJS.push(chart);
        }

        function renderGrowthChart(body, data) {
            if (!data.income || data.income.length < 2) { body.innerHTML = '<div class="chart-nodata">Need 2+ years of data for growth trends</div>'; return; }
            const c = cjsColors();
            body.innerHTML = '<div class="chart-wrap"><canvas id="grChart"></canvas></div>';
            const labels = [], revGr = [], epsGr = [], fcfGr = [];
            for (let i = 1; i < data.income.length; i++) {
                labels.push(data.income[i].label);
                const prev = data.income[i-1], curr = data.income[i];
                revGr.push(prev.revenue ? ((curr.revenue - prev.revenue) / Math.abs(prev.revenue)) * 100 : null);
                epsGr.push(prev.eps ? ((curr.eps - prev.eps) / Math.abs(prev.eps)) * 100 : null);
            }
            if (data.cashflow && data.cashflow.length >= 2) {
                for (let i = 1; i < data.cashflow.length; i++) {
                    const prev = (data.cashflow[i-1].operating||0)+(data.cashflow[i-1].capex||0);
                    const curr = (data.cashflow[i].operating||0)+(data.cashflow[i].capex||0);
                    fcfGr.push(prev ? ((curr - prev) / Math.abs(prev)) * 100 : null);
                }
            }
            const chart = new Chart(document.getElementById('grChart'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: 'Revenue Growth', data: revGr, borderColor: c.blue, backgroundColor: 'transparent', borderWidth: 2, pointRadius: 4, pointBackgroundColor: c.blue },
                        { label: 'EPS Growth', data: epsGr, borderColor: c.green, backgroundColor: 'transparent', borderWidth: 2, pointRadius: 4, pointBackgroundColor: c.green },
                        ...(fcfGr.length ? [{ label: 'FCF Growth', data: fcfGr, borderColor: c.cyan, backgroundColor: 'transparent', borderWidth: 2, pointRadius: 4, pointBackgroundColor: c.cyan }] : [])
                    ]
                },
                options: cjsOpts('Year-over-Year Growth', fmtPct)
            });
            activeChartJS.push(chart);
        }

        function renderMarginsChart(body, data) {
            if (!data.income || !data.income.length) { body.innerHTML = '<div class="chart-nodata">No data for margin analysis</div>'; return; }
            const c = cjsColors();
            body.innerHTML = '<div class="chart-wrap"><canvas id="mrChart"></canvas></div>';
            const labels = data.income.map(d => d.label);
            const gross = data.income.map(d => d.revenue ? (d.gross_profit / d.revenue) * 100 : null);
            const op = data.income.map(d => d.revenue ? (d.op_income / d.revenue) * 100 : null);
            const net = data.income.map(d => d.revenue ? (d.net_income / d.revenue) * 100 : null);
            const chart = new Chart(document.getElementById('mrChart'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: 'Gross Margin', data: gross, borderColor: c.green, backgroundColor: 'rgba(34,197,94,0.1)', fill: true, borderWidth: 2, pointRadius: 4, pointBackgroundColor: c.green },
                        { label: 'Operating Margin', data: op, borderColor: c.blue, backgroundColor: 'transparent', borderWidth: 2, pointRadius: 4, pointBackgroundColor: c.blue },
                        { label: 'Net Margin', data: net, borderColor: c.purple, backgroundColor: 'transparent', borderWidth: 2, pointRadius: 4, pointBackgroundColor: c.purple }
                    ]
                },
                options: cjsOpts('Profit Margins', fmtPct)
            });
            activeChartJS.push(chart);
        }

        function renderAllocationChart(body, data) {
            if (!data.income || !data.income.length) { body.innerHTML = '<div class="chart-nodata">No data for revenue allocation</div>'; return; }
            const c = cjsColors();
            const latest = data.income[data.income.length - 1];
            if (!latest.revenue || latest.revenue <= 0) { body.innerHTML = '<div class="chart-nodata">No positive revenue to display</div>'; return; }
            body.innerHTML = '<div class="chart-wrap" style="max-width:500px;margin:0 auto"><canvas id="alChart"></canvas></div>';
            const cogs = Math.abs(latest.cost_of_revenue || 0);
            const opex = Math.abs((latest.op_expenses || 0) - (latest.cost_of_revenue || 0));
            const otherExp = Math.abs((latest.op_income || 0) - (latest.net_income || 0));
            const netInc = Math.max(latest.net_income || 0, 0);
            const total = cogs + opex + otherExp + netInc;
            // Normalize if total doesn't match revenue
            const items = [
                { label: 'Cost of Revenue', value: cogs, color: c.red },
                { label: 'Operating Expenses', value: opex, color: c.orange },
                { label: 'Other / Tax', value: otherExp, color: c.yellow },
                { label: 'Net Income', value: netInc, color: c.green }
            ].filter(i => i.value > 0);
            const chart = new Chart(document.getElementById('alChart'), {
                type: 'doughnut',
                data: {
                    labels: items.map(i => i.label),
                    datasets: [{
                        data: items.map(i => i.value),
                        backgroundColor: items.map(i => i.color),
                        borderColor: c.bg, borderWidth: 2
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: c.text, font: { family: "'JetBrains Mono', monospace", size: 11 }, padding: 12 } },
                        title: { display: true, text: `Revenue Allocation (${latest.label})`, color: c.text, font: { family: "'Outfit', sans-serif", size: 14, weight: 600 } },
                        tooltip: { callbacks: { label: ctx => `${ctx.label}: ${fmtDollar(ctx.parsed)} (${((ctx.parsed / latest.revenue) * 100).toFixed(1)}%)` } }
                    }
                }
            });
            activeChartJS.push(chart);
        }

        function fmc(v) { if (!v) return '—'; v = +v; if (v >= 1e12) return `$${(v / 1e12).toFixed(2)}T`; if (v >= 1e9) return `$${(v / 1e9).toFixed(1)}B`; if (v >= 1e6) return `$${(v / 1e6).toFixed(0)}M`; return `$${v.toLocaleString()}` }
        function stats() { $('sT').textContent = A.length; $('sH').textContent = A.filter(s => s.markov_state === 'HOT').length; $('sW').textContent = A.filter(s => s.markov_state === 'WARM').length; $('sC').textContent = A.filter(s => s.markov_state === 'COLD').length; $('sF').textContent = A.filter(s => s.markov_state === 'FROZEN').length; $('sK').textContent = A.filter(s => s.is_triple_crown).length }
        function $(id) { return document.getElementById(id) }
        function toggleTheme() {
            const b = document.body; b.dataset.theme = b.dataset.theme === 'dark' ? 'light' : 'dark';
            try { localStorage.setItem('ss-t', b.dataset.theme) } catch (e) { }
            // Re-render active chart tab on theme change
            if (EX) { const tab = document.querySelector('.chart-tab.active'); if (tab) { const s = F.find(x => x.ticker === EX); if (s) switchTab(tab.dataset.tab, EX, s); } }
        }
        try { const t = localStorage.getItem('ss-t'); if (t) document.body.dataset.theme = t } catch (e) { }

        window.addEventListener('scroll', () => { if (RC >= F.length) return; if (window.innerHeight + window.scrollY > document.documentElement.scrollHeight - 500) render() });
        let dt; $('q').addEventListener('input', () => { clearTimeout(dt); dt = setTimeout(af, 200) });
        $('fSec').addEventListener('change', af); $('fTier').addEventListener('change', af); $('fSt').addEventListener('change', af); $('fVal').addEventListener('change', af); $('fFlg').addEventListener('change', af);
        $('srt').addEventListener('change', e => { const [c, d] = e.target.value.split('-'); S = { c, d: d === 'a' ? 'asc' : 'desc' }; ss(); RC = 0; render() });
        const MC_STEPS = [0, 1e8, 1e9, 1e10, 1e11, 5e11], MC_LABELS = ['All', '$100M+', '$1B+', '$10B+', '$100B+', '$500B+'];
        $('mcSlider').addEventListener('input', e => { const v = +e.target.value; $('mcL').textContent = MC_LABELS[v]; af() });
        document.querySelectorAll('th[data-c]').forEach(t => t.addEventListener('click', () => setS(t.dataset.c)));

        // Inject toolbar SVG icons
        $('siH').innerHTML = icon('hot', 13, 'var(--red)');
        $('siW').innerHTML = icon('warm', 13, 'var(--orange)');
        $('siC').innerHTML = icon('cold', 13, 'var(--blue)');
        $('siF').innerHTML = icon('frozen', 13, 'var(--text-faint)');
        $('siK').innerHTML = icon('crown', 13, 'var(--yellow)');

        load();
    </script>
</body>

</html>